<?php
$page = "course-details";
include_once('head-nav.php');
include_once('config.php');

if (!isset($_GET['id']) || !is_numeric($_GET['id'])) {
  die("Invalid course ID");
}
$course_id = intval($_GET['id']);

// -------- FETCH COURSE DATA --------
$sql = "
SELECT 
  l.id,
  l.name AS title,
  l.info AS description,
  l.duration,
  l.price,
  l.course_mode,
  cm.subtitle,
  cm.discount_price,
  cm.badge,
  cm.image,
  m.overview,
  m.skills,
  m.objectives,
  m.audience,
  m.brochure_path,
  i.user_login,
  i.specialty,
  i.avatar,
  u.name AS instructor_name,
  u.surname AS instructor_surname
FROM lessons l
LEFT JOIN course_marketplace cm ON cm.lesson_id = l.id
LEFT JOIN course_metadata m ON m.course_id = l.id
LEFT JOIN instructors i ON i.user_login = l.creator_LOGIN
LEFT JOIN users u ON u.login = i.user_login
WHERE l.id = $course_id
LIMIT 1
";

$res = mysqli_query($coni, $sql);
if (!$res || mysqli_num_rows($res) == 0) {
  die("Course not found");
}
$course = mysqli_fetch_assoc($res);

// -------- FETCH LESSONS (Modules) + TOPICS --------
$modules = [];
$mod_q = mysqli_query($coni, "SELECT id, module_title FROM modules WHERE course_id=$course_id ORDER BY module_order ASC");
if ($mod_q && mysqli_num_rows($mod_q) > 0) {
  while ($m = mysqli_fetch_assoc($mod_q)) {
    $topics = [];
    $top_q = mysqli_query($coni, "SELECT topic_title FROM content WHERE module_id={$m['id']} ORDER BY topic_order ASC");
    while ($t = mysqli_fetch_assoc($top_q)) {
      $topics[] = $t['topic_title'];
    }
    $m['topics'] = $topics;
    $modules[] = $m;
  }
}
?>

<main class="main">

  <!-- Page Title -->
  <div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
      <h1 class="mb-2 mb-lg-0"><?php echo htmlspecialchars($course['title']); ?></h1>
      <nav class="breadcrumbs">
        <ol>
          <li><a href="index.php">Home</a></li>
          <li class="current">Course Details</li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Course Details -->
  <section id="course-details" class="course-details section">
    <div class="container" data-aos="fade-up" data-aos-delay="100">

      <div class="row">
        <!-- LEFT COLUMN -->
        <div class="col-lg-8">

          <!-- Hero Section -->
          <div class="course-hero mb-4">
            <div class="hero-content">
              <div class="course-badge">
                <span class="category"><?php echo htmlspecialchars($course['badge']); ?></span>
                <span class="level"><?php echo htmlspecialchars($course['course_mode']); ?></span>
              </div>
              <h1><?php echo htmlspecialchars($course['title']); ?></h1>
              <?php if ($course['subtitle']) { ?>
                <p class="course-subtitle"><?php echo htmlspecialchars($course['subtitle']); ?></p>
              <?php } ?>

              <?php if ($course['instructor_name']) { ?>
              <div class="instructor-card mt-3 d-flex align-items-center">
                <img src="<?php echo $course['avatar'] ?: 'assets/img/person/default-avatar.webp'; ?>" class="instructor-image me-3" alt="Instructor">
                <div>
                  <h5><?php echo htmlspecialchars($course['instructor_name'] . " " . $course['instructor_surname']); ?></h5>
                  <span><?php echo htmlspecialchars($course['specialty']); ?></span>
                </div>
              </div>
              <?php } ?>
            </div>

            <div class="hero-image mt-3">
              <img src="<?php echo $course['image'] ?: 'assets/img/education/default-course.webp'; ?>" class="img-fluid rounded" alt="Course Image">
            </div>
          </div>

          <!-- Tabs -->
          <ul class="nav nav-tabs mb-4" id="courseTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                <i class="bi bi-layout-text-window-reverse"></i> Overview
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" id="curriculum-tab" data-bs-toggle="tab" data-bs-target="#curriculum" type="button">
                <i class="bi bi-list-ul"></i> Curriculum
              </button>
            </li>
          </ul>

          <div class="tab-content">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview">
              <h3>Course Description</h3>
              <p><?php echo nl2br($course['overview'] ?: $course['description']); ?></p>

              <?php if (!empty($course['skills'])): ?>
                <h3 class="mt-4">Skills You'll Gain</h3>
                <ul class="requirements-list">
                  <?php foreach (explode("\n", $course['skills']) as $skill):
                    if (trim($skill) == '') continue; ?>
                    <li><i class="bi bi-check2"></i> <?php echo htmlspecialchars(trim($skill)); ?></li>
                  <?php endforeach; ?>
                </ul>
              <?php endif; ?>

              <?php if (!empty($course['objectives'])): ?>
                <h3 class="mt-4">Learning Objectives</h3>
                <p><?php echo nl2br($course['objectives']); ?></p>
              <?php endif; ?>

              <?php if (!empty($course['audience'])): ?>
                <h3 class="mt-4">Target Audience</h3>
                <p><?php echo nl2br($course['audience']); ?></p>
              <?php endif; ?>
            </div>

            <!-- Curriculum Tab -->
            <div class="tab-pane fade" id="curriculum">
              <?php if (count($modules) > 0): ?>
                <div class="accordion" id="curriculumAccordion">
                  <?php foreach ($modules as $i => $m): ?>
                    <div class="accordion-item curriculum-module">
                      <h2 class="accordion-header">
                        <button class="accordion-button <?php echo ($i > 0 ? 'collapsed' : ''); ?>" type="button" data-bs-toggle="collapse" data-bs-target="#module<?php echo $m['id']; ?>">
                          <span class="module-title"><?php echo htmlspecialchars($m['module_title']); ?></span>
                        </button>
                      </h2>
                      <div id="module<?php echo $m['id']; ?>" class="accordion-collapse collapse <?php echo ($i == 0 ? 'show' : ''); ?>" data-bs-parent="#curriculumAccordion">
                        <div class="accordion-body">
                          <?php if (count($m['topics']) > 0): ?>
                            <ul class="list-group list-group-flush">
                              <?php foreach ($m['topics'] as $t): ?>
                                <li class="list-group-item">
                                  <i class="bi bi-play-circle me-2"></i> <?php echo htmlspecialchars($t); ?>
                                </li>
                              <?php endforeach; ?>
                            </ul>
                          <?php else: ?>
                            <p class="text-muted">No topics added.</p>
                          <?php endif; ?>
                        </div>
                      </div>
                    </div>
                  <?php endforeach; ?>
                </div>
              <?php else: ?>
                <p>No lessons or topics available yet.</p>
              <?php endif; ?>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-lg-4">

          <div class="enrollment-card" data-aos="fade-up" data-aos-delay="200">
            <div class="card-header">
              <div class="price-display">
                <span class="current-price">₹<?php echo number_format($course['discount_price'] ?: $course['price']); ?></span>
                <?php if ($course['discount_price'] > 0): ?>
                  <span class="original-price">₹<?php echo number_format($course['price']); ?></span>
                <?php endif; ?>
              </div>
            </div>

            <div class="card-body">
              <div class="course-highlights mb-3">
                <div><i class="bi bi-clock-history me-2"></i> <?php echo intval($course['duration']); ?> Weeks</div>
                <div><i class="bi bi-award me-2"></i> <?php echo htmlspecialchars($course['badge']); ?></div>
                <div><i class="bi bi-translate me-2"></i> English</div>
              </div>

              <div class="action-buttons">
                <button class="btn btn-primary w-100 mb-2">Enroll Now</button>

                <?php if (!empty($course['brochure_path'])): ?>
                  <a href="<?php echo htmlspecialchars($course['brochure_path']); ?>" target="_blank" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-download"></i> Download Brochure
                  </a>
                <?php else: ?>
                  <button class="btn btn-outline-secondary w-100" disabled>
                    <i class="bi bi-file-earmark"></i> Brochure Not Available
                  </button>
                <?php endif; ?>
              </div>
            </div>
          </div>

          <div class="course-details-card mt-4" data-aos="fade-up" data-aos-delay="300">
            <h4>Course Details</h4>
            <div class="detail-grid">
              <div class="detail-row"><span class="detail-label">Mode</span><span class="detail-value"><?php echo htmlspecialchars($course['course_mode']); ?></span></div>
              <div class="detail-row"><span class="detail-label">Duration</span><span class="detail-value"><?php echo intval($course['duration']); ?> Weeks</span></div>
              <div class="detail-row"><span class="detail-label">Language</span><span class="detail-value">English</span></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</main>

<?php include_once('footer.php'); ?>
